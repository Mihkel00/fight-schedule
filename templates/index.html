<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fight Schedule</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Staatliches&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'staatliches': ['"Staatliches"', 'Impact', 'sans-serif'],
                        'work': ['"Work Sans"', 'sans-serif'],
                    },
                    colors: {
                        'dark-bg': '#0f0f0f',
                        'dark-card': '#121212',
                        'dark-elevated': '#242424',
                        'dark-border': '#2a2a2a',
                        'text-primary': '#ffffff',
                        'text-secondary': '#a3a3a3',
                        'text-tertiary': '#6b6b6b',
                        'accent-blue': '#3b82f6',
                        'accent-red': '#dc2626',
                        'accent-red-custom': '#C00000',
                        'accent-orange': '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body class="bg-dark-bg text-text-primary">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header with Logo -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white tracking-tight leading-tight" style="font-family: 'Impact', 'Arial Black', sans-serif; letter-spacing: 0.02em;">
                FIGHT<br><span class="text-text-secondary">SCHEDULE</span>
            </h1>
        </div>

        <!-- Search Bar and Filter Pills -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                <!-- Search Bar -->
                <div class="w-full md:w-96">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input 
                            id="search-input" 
                            type="text" 
                            placeholder="Search fighter or event" 
                            class="block w-full pl-10 pr-3 py-3 border border-dark-border rounded-lg bg-dark-bg text-text-primary placeholder-text-tertiary focus:outline-none focus:ring-2 focus:ring-accent-blue focus:border-transparent"
                        >
                    </div>
                </div>

                <!-- Filter Pills -->
                <div class="flex gap-3">
                    <button id="filter-all" class="px-6 py-2.5 bg-text-primary text-dark-bg rounded-full font-medium text-sm filter-btn active">All</button>
                    <button id="filter-ufc" class="px-6 py-2.5 bg-dark-card text-text-secondary rounded-full font-medium text-sm hover:bg-dark-elevated transition-colors filter-btn">UFC</button>
                    <button id="filter-boxing" class="px-6 py-2.5 bg-dark-card text-text-secondary rounded-full font-medium text-sm hover:bg-dark-elevated transition-colors filter-btn">Boxing</button>
                </div>
            </div>
        </div>

        <!-- Results count -->
        <div id="results-count" class="mb-4 text-text-secondary text-sm"></div>

        <!-- Upcoming Fights Section -->
        <h2 class="font-work text-lg font-semibold mb-4">Upcoming Fights</h2>
        
        <!-- Card Grid Container -->
        <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            <!-- Cards rendered by JavaScript -->
        </div>

        <!-- More Upcoming Fights Section -->
        <div id="list-section-wrapper" style="display: none;">
            <h2 class="font-work text-lg font-semibold mb-4">More Upcoming Fights</h2>
            
            <div id="list-container" class="bg-dark-card rounded-xl border border-dark-border divide-y divide-dark-border">
                <!-- List items rendered by JavaScript -->
            </div>
        </div>

        <!-- No fights message -->
        <div id="no-fights" class="bg-dark-card rounded-xl p-8 border border-dark-border text-center" style="display: none;">
            <p class="text-text-secondary">No fights found.</p>
        </div>
    </div>

    <script>
        // Fights data from backend
        const allFights = {{ fights_json|safe }};
        
        // Timezone detection
        let userTimezone = 'Europe/London'; // Default fallback
        let timezoneOffset = 0;
        let timezoneCity = 'London';
        
        try {
            userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            timezoneOffset = new Date().getTimezoneOffset() / -60;
            timezoneCity = userTimezone.split('/').pop().replace(/_/g, ' ');
        } catch (e) {
            console.error('Timezone detection failed:', e);
        }
        
        // Current filter state
        let currentFilter = localStorage.getItem('fightScheduleFilter') || 'ALL';
        let currentSearchTerm = '';
        
        // Convert UK time to user's local time
        function convertToUserTime(dateStr, timeStr) {
            if (!timeStr || timeStr === 'TBA') return { time: 'TBA', date: dateStr };
            
            try {
                // Parse UK time as UTC (UK times stored as UTC in winter, close enough)
                const [hours, minutes] = timeStr.split(':');
                const utcDateTime = new Date(`${dateStr}T${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:00Z`);
                
                // Convert to user's timezone
                const localDate = new Date(utcDateTime.toLocaleString('en-US', { timeZone: userTimezone }));
                
                // Format time
                const localTime = localDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                // Format date (in case it changed due to timezone)
                const localDateStr = localDate.toISOString().split('T')[0];
                
                return {
                    time: localTime,
                    date: localDateStr,
                    dateChanged: localDateStr !== dateStr
                };
            } catch (e) {
                console.error('Time conversion error:', e);
                return { time: timeStr, date: dateStr };
            }
        }
        
        // Create boxing event slug
        function createBoxingEventSlug(fight) {
            if (fight.sport !== 'Boxing') return null;
            const venueParts = fight.venue.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .split(' ')
                .filter(p => p.length > 2)
                .slice(0, 3)
                .join('-');
            return `${venueParts}-${fight.date}`;
        }
        
        // Create event slug
        function createEventSlug(fight) {
            if (fight.sport === 'Boxing') {
                return createBoxingEventSlug(fight);
            }
            
            // UFC slug
            if (fight.sport !== 'UFC') return null;
            const eventSlug = fight.event_name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            return `${eventSlug}-${fight.date}`;
        }
        
        // Format date helper
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // Render fight card
        function renderCard(fight) {
            const converted = convertToUserTime(fight.date, fight.time);
            const displayDate = converted.dateChanged ? converted.date : fight.date;
            
            const cardType = fight.card_type ? `${fight.card_type}: ` : '';
            const timeDisplay = converted.time !== 'TBA' ? 
                (fight.sport === 'UFC' && fight.card_type ? 
                    ` • ${cardType}${converted.time} ${timezoneCity}` : 
                    ` • ${converted.time} ${timezoneCity}`) : '';
            
            const sportDot = fight.sport === 'UFC' ? 
                `<span class="w-2 h-2 rounded-full bg-accent-red"></span>` :
                `<span class="w-2 h-2 rounded-full bg-accent-orange"></span>`;
            
            const sportLabel = fight.sport === 'UFC' ? 'UFC' : 'Boxing';
            
            const placeholder = fight.sport === 'UFC' ? 
                '/static/placeholder-fighter-mma.png' :
                '/static/placeholder-fighter-boxing.png';
            
            const img1 = fight.fighter1_image || placeholder;
            const img2 = fight.fighter2_image || placeholder;
            const opacity1 = fight.fighter1_image ? '' : 'opacity-40';
            const opacity2 = fight.fighter2_image ? '' : 'opacity-40';
            
            // Generate event link
            const eventSlug = createEventSlug(fight);
            const eventLink = fight.sport === 'UFC' ? `/event/${eventSlug}` : `/boxing-event/${eventSlug}`;
            
            return `
                <div onclick="window.location.href='${eventLink}'" class="bg-dark-card rounded-xl p-6 border border-dark-border hover:bg-dark-elevated hover:border-dark-elevated transition-all cursor-pointer" data-sport="${fight.sport}">
                    <div class="flex items-center justify-center gap-6 mb-6">
                        <div class="text-center w-40">
                            <div class="w-20 h-20 rounded-full bg-dark-elevated mb-3 mx-auto overflow-hidden">
                                <img src="${img1}" alt="${fight.fighter1}" class="w-full h-full object-cover ${opacity1}">
                            </div>
                            <p class="font-staatliches text-[20px] leading-tight tracking-wide line-clamp-2 uppercase h-12 flex items-center justify-center">${fight.fighter1}</p>
                        </div>
                        <div class="font-work font-semibold text-base italic uppercase text-text-secondary">VS</div>
                        <div class="text-center w-40">
                            <div class="w-20 h-20 rounded-full bg-dark-elevated mb-3 mx-auto overflow-hidden">
                                <img src="${img2}" alt="${fight.fighter2}" class="w-full h-full object-cover ${opacity2}">
                            </div>
                            <p class="font-staatliches text-[20px] leading-tight tracking-wide line-clamp-2 uppercase h-12 flex items-center justify-center">${fight.fighter2}</p>
                        </div>
                    </div>
                    <div class="border-t border-dark-border pt-4">
                        <p class="text-accent-red-custom font-work font-semibold mb-2">
                            ${formatDate(displayDate)}${timeDisplay}
                        </p>
                        <div class="flex items-center justify-between">
                            <span class="font-work text-xs text-text-tertiary">${fight.venue}</span>
                            <span class="flex items-center gap-1.5">
                                ${sportDot}
                                <span class="font-work text-[11px] uppercase tracking-wider text-text-secondary">${sportLabel}</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Render list item
        function renderListItem(fight) {
            const converted = convertToUserTime(fight.date, fight.time);
            const displayDate = converted.dateChanged ? converted.date : fight.date;
            
            const cardType = fight.card_type ? `${fight.card_type}: ` : '';
            const timeDisplay = converted.time !== 'TBA' ? 
                (fight.sport === 'UFC' && fight.card_type ? 
                    ` • ${cardType}${converted.time} ${timezoneCity}` : 
                    ` • ${converted.time} ${timezoneCity}`) : '';
            
            const sportDot = fight.sport === 'UFC' ? 
                `<span class="w-2 h-2 rounded-full bg-accent-red"></span>` :
                `<span class="w-2 h-2 rounded-full bg-accent-orange"></span>`;
            
            const sportLabel = fight.sport === 'UFC' ? 'UFC' : 'Boxing';
            
            return `
                <div class="px-6 py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-6 hover:bg-dark-elevated transition-colors cursor-pointer" data-sport="${fight.sport}">
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="font-work font-medium text-text-primary">${fight.fighter1} vs ${fight.fighter2}</span>
                        <span class="flex items-center gap-1.5">
                            ${sportDot}
                            <span class="font-work text-[11px] uppercase tracking-wider text-text-secondary">${sportLabel}</span>
                        </span>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-6">
                        <span class="text-accent-red-custom font-work font-normal whitespace-nowrap text-sm md:text-base">
                            ${formatDate(displayDate)}${timeDisplay}
                        </span>
                        <span class="font-work text-text-tertiary text-xs">${fight.venue}</span>
                    </div>
                </div>
            `;
        }
        
        // Filter fights by current search and sport filter
        function getFilteredFights() {
            let filtered = allFights;
            
            // Apply sport filter
            if (currentFilter !== 'ALL') {
                filtered = filtered.filter(f => f.sport.toUpperCase() === currentFilter);
            }
            
            // Apply search filter
            if (currentSearchTerm) {
                const term = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(f => 
                    f.fighter1.toLowerCase().includes(term) ||
                    f.fighter2.toLowerCase().includes(term) ||
                    (f.event_name && f.event_name.toLowerCase().includes(term)) ||
                    (f.venue && f.venue.toLowerCase().includes(term))
                );
            }
            
            return filtered;
        }
        
        // Update results count
        function updateResultsCount(count) {
            const resultsCount = document.getElementById('results-count');
            if (currentSearchTerm || currentFilter !== 'ALL') {
                resultsCount.textContent = `Showing ${count} fight${count !== 1 ? 's' : ''}`;
                resultsCount.style.display = 'block';
            } else {
                resultsCount.style.display = 'none';
            }
        }
        
        // Main render function
        function renderFights(fights) {
            const cardGrid = document.getElementById('card-grid');
            const listContainer = document.getElementById('list-container');
            const listWrapper = document.getElementById('list-section-wrapper');
            const noFights = document.getElementById('no-fights');
            
            updateResultsCount(fights.length);
            
            if (fights.length === 0) {
                cardGrid.innerHTML = '';
                listWrapper.style.display = 'none';
                noFights.style.display = 'block';
                return;
            }
            
            noFights.style.display = 'none';
            
            // First 8 as cards
            cardGrid.innerHTML = fights.slice(0, 8).map(renderCard).join('');
            
            // Rest as list
            if (fights.length > 8) {
                listContainer.innerHTML = fights.slice(8).map(renderListItem).join('');
                listWrapper.style.display = 'block';
            } else {
                listWrapper.style.display = 'none';
            }
        }
        
        // Apply current filters and render
        function applyFiltersAndRender() {
            const filtered = getFilteredFights();
            renderFights(filtered);
        }
        
        // Search functionality with debouncing
        let searchTimeout;
        const searchInput = document.getElementById('search-input');
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchTerm = e.target.value.trim();
                applyFiltersAndRender();
            }, 300);
        });
        
        // Filter functionality
        const filterButtons = document.querySelectorAll('.filter-btn');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Update button states
                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-text-primary', 'text-dark-bg');
                    btn.classList.add('bg-dark-card', 'text-text-secondary');
                });
                
                button.classList.add('active', 'bg-text-primary', 'text-dark-bg');
                button.classList.remove('bg-dark-card', 'text-text-secondary');
                
                // Update filter and save to localStorage
                currentFilter = button.id.replace('filter-', '').toUpperCase();
                localStorage.setItem('fightScheduleFilter', currentFilter);
                
                // Apply filters and render
                applyFiltersAndRender();
            });
        });
        
        // Restore saved filter on page load
        function restoreSavedFilter() {
            const savedFilter = localStorage.getItem('fightScheduleFilter') || 'ALL';
            currentFilter = savedFilter;
            
            // Update button states to match saved filter
            filterButtons.forEach(btn => {
                const btnFilter = btn.id.replace('filter-', '').toUpperCase();
                if (btnFilter === savedFilter) {
                    btn.classList.add('active', 'bg-text-primary', 'text-dark-bg');
                    btn.classList.remove('bg-dark-card', 'text-text-secondary');
                } else {
                    btn.classList.remove('active', 'bg-text-primary', 'text-dark-bg');
                    btn.classList.add('bg-dark-card', 'text-text-secondary');
                }
            });
        }
        
        // Initialize
        restoreSavedFilter();
        applyFiltersAndRender();
    </script>
</body>
</html>
